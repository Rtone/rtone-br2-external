#!/bin/bash
#
# Copyright 2024 GaÃ«l PORTAY
#           2024 Rtone
#
# SPDX-License-Identifier: GPL-2.0-only
#

if ! part="$(xxd -o0 -l4 -p /sys/firmware/devicetree/base/chosen/bootloader/partition)"
then
	exit 1
fi

if ! part="$(("0x$part"))"
then
	exit 1
fi

if ! unit="$(systemd-escape boot/firmware.mount)"
then
	exit 1
fi

mkdir -p "$1"
cat <<EOF >"$1/$unit"
# Automatically generated by ${0##*/}"

[Unit]
Documentation=https://www.raspberrypi.com/documentation/computers/config_txt.html#autoboot-txt
Documentation=https://www.raspberrypi.com/documentation/computers/raspberry-pi.html#fail-safe-os-updates-tryboot
SourcePath=/sys/firmware/devicetree/base/chosen/bootloader/partition
Before=local-fs.target
After=-boot.mount

[Mount]
What=/dev/mmcblk0p$part
Where=/boot/firmware
Type=vfat
Options=rw
EOF
mkdir -p "$1/local-fs.target.wants"
ln -sf "../$unit" "$1/local-fs.target.wants/$unit"
