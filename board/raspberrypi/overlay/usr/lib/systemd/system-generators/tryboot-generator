#!/bin/bash
#
# Copyright 2024 GaÃ«l PORTAY
#           2024 Rtone
#
# SPDX-License-Identifier: GPL-2.0-only
#

if ! tryboot="$(xxd -o0 -l4 -p /sys/firmware/devicetree/base/chosen/bootloader/tryboot)"
then
	exit 1
fi

if ! tryboot="$(("0x$tryboot"))"
then
	exit 1
fi

if [[ "$tryboot" -eq 0 ]]
then
	exit 0
fi

mkdir -p "$1"
cat <<EOF >"$1/tryboot-commit.service"
# Automatically generated by ${0##*/}"

[Unit]
Documentation=https://www.raspberrypi.com/documentation/computers/config_txt.html#autoboot-txt
Documentation=https://www.raspberrypi.com/documentation/computers/raspberry-pi.html#fail-safe-os-updates-tryboot
SourcePath=/sys/firmware/devicetree/base/chosen/bootloader/tryboot
ConditionPathExists=/sys/firmware/devicetree/base/chosen/bootloader/tryboot
ConditionPathExists=/boot/firmware/tryboot.txt
After=boot-firmware.mount

[Service]
Type=oneshot
ExecStart=/usr/bin/tryboot commit
EOF
mkdir -p "$1/multi-user.target.wants"
ln -sf "../tryboot-commit.service" "$1/multi-user.target.wants/tryboot-commit.service"
